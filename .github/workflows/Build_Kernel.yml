name: Build Kernel
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      target_devices:
        description: 'target device (ç›®æ ‡è®¾å¤‡)'
        required: true
        type: choice
        default: 'lmi'
        options:
          - 'lmi'
          - 'umi'
          - 'cmi'
          - 'cas'
          - 'thyme'
          - 'munch'
          - 'dagu'
          - 'elish'
          - 'enuma'
          - 'alioth'
          - 'apollo'
          - 'psyche'
          - 'pipa'
          - 'all'
      kernelsu_enable:
        description: 'Is Ksu support enabled? (æ˜¯å¦å¯ç”¨ kernelsu æ”¯æŒ?)'
        required: true
        type: choice
        default: 'disable'
        options:
          - 'ksu'
          - 'disable'
      a16_bpf:
        description: 'Is a16_bpf support? (æ˜¯å¦åˆå¹¶a16bpfæ”¯æŒ?)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'true'
          - 'false'
      kernel_version:
        description: 'Customizing the kernel version number (è‡ªå®šä¹‰å†…æ ¸ç‰ˆæœ¬å·)'
        required: false
        type: string
        default: ''
      build_type:
        description: 'Kernel Build Type (å†…æ ¸æ„å»ºç±»å‹)'
        required: true
        type: choice
        default: 'Release'
        options:
          - 'Release'
          - 'Dev'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          DEVICES="${{ github.event.inputs.target_devices }}"
          if [ "$DEVICES" == "all" ]; then
            DEVICES="umi,cmi,cas,thyme,munch,dagu,elish,enuma,alioth,apollo,lmi,psyche,pipa"
          fi
          DEVICES_JSON="[$(echo $DEVICES | sed 's/,/","/g' | sed 's/.*/"&"/')]"
          echo "matrix={\"device\":$DEVICES_JSON}" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    strategy:
      matrix: ${{fromJson(needs.prepare.outputs.matrix)}}
      fail-fast: false
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      WORKDIR: "${{ github.workspace }}"
      KERNEL_SOURCE: "${{ github.workspace }}/kernel_source"
      DEVICE: "${{ matrix.device }}"

    steps:
      - name: ğŸ“¢ Build Information (æ„å»ºä¿¡æ¯)
        run: |
          echo "è®¾å¤‡: ${DEVICE}"
          echo "KernelSUæ”¯æŒ: ${{ github.event.inputs.kernelsu_enable }}"
          echo "æ„å»ºç±»å‹: ${{ github.event.inputs.build_type }}"

      - name: ğŸš€ Maximize build space (æœ€å¤§åŒ–æ„å»ºç©ºé—´)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"

      - name: è·å–a16bpfè¡¥ä¸
        if: github.event.inputs.a16_bpf == 'true'
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.SECRET_NAME }}
          repository: Meetingf/a16bpf

      - name: ğŸ“¦ Installation of dependencies (å®‰è£…ä¾èµ–)
        run: |
          sudo apt-get update -y 
          sudo apt-get install -y \
          build-essential git curl wget bison flex zip bc \
          cpio libssl-dev libncurses-dev gcc \
          python3 python3-pip ccache

      - name: ğŸ“¥ Caching toolchain (ç¼“å­˜å·¥å…·é“¾)
        uses: actions/cache@v4
        id: clang-cache
        with:
          path: $HOME/proton-clang
          key: ${{ runner.os }}-proton-clang

      - name: ğŸ“¥ Download the compilation toolchain (ä¸‹è½½ç¼–è¯‘å·¥å…·é“¾)
        if: steps.clang-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p $HOME/proton-clang
          cd $HOME/proton-clang
          wget https://github.com/kdrag0n/proton-clang/archive/refs/tags/20210522.zip
          unzip 20210522.zip
          rm proton-clang-20210522/bin/ld 20210522.zip

      - name: ğŸ“¥ Cloning kernel source code (å…‹éš†å†…æ ¸æºç )
        run: |
          echo "æ­£åœ¨å…‹éš†å†…æ ¸æºç ..."
          git clone https://github.com/liyafe1997/kernel_xiaomi_sm8250_mod.git --depth=1 $KERNEL_SOURCE
          echo "âœ… Kernel source code cloning complete (å†…æ ¸æºç å…‹éš†å®Œæˆ)"
          if [ $github.event.inputs.a16_bpf = 'true' ];then
              cd $KERNEL_SOURCE
              git apply $WORKDIR/a16bpf.diff
              git add .
              git commit -m "åˆå¹¶a16bpf"
          fi

      - name: ğŸ”¨ Build the kernel (æ„å»ºå†…æ ¸)
        run: |
          cd $KERNEL_SOURCE
          KSU_enable="${{ github.event.inputs.kernelsu_enable }}"
          VERSION="${{ github.event.inputs.kernel_version }}"

          # ä¿®æ”¹å†…æ ¸ç‰ˆæœ¬å·
          if [ ! -z "$VERSION" ]; then
              echo "ğŸ”§ è®¾ç½®è‡ªå®šä¹‰å†…æ ¸ç‰ˆæœ¬: $VERSION"
              sed -i "s/-dirty/-$VERSION/g" scripts/setlocalversion
          else
              GIT_COMMIT_SHORT=$(git rev-parse --short=13 HEAD)
              echo "ğŸ”§ ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬"
              sed -i "s/-dirty/-${GIT_COMMIT_SHORT}-${DEVICE}/g" scripts/setlocalversion
              sed -i "s/echo \"\$res\"/echo \"-perf-${GIT_COMMIT_SHORT}-${DEVICE}\"/g" "$KERNEL_SOURCE/scripts/setlocalversion"
          fi

          FULL_VERSION="$VERSION"
          if [ ! -z "$FULL_VERSION" ]; then
            main_version=$(echo "$FULL_VERSION" | grep -oE '^[0-9]+(\.[0-9]+)*')
            custom_part=$(echo "$FULL_VERSION" | grep -oE '(-[a-zA-Z0-9]+)*$')
            makefile_path="$KERNEL_SOURCE/Makefile"
            IFS='.' read -ra version_parts <<< "$main_version"
            sed -i "2s/.*/VERSION = ${version_parts[0]}/" "$makefile_path"
            if [ -n "${version_parts[1]}" ]; then
              sed -i "3s/.*/PATCHLEVEL = ${version_parts[1]}/" "$makefile_path"
            fi
            if [ -n "${version_parts[2]}" ]; then
              sed -i "4s/.*/SUBLEVEL = ${version_parts[2]}/" "$makefile_path"
            fi

            sed -i "s/echo \"\$res\"/echo \"${custom_part}\"/g" "$KERNEL_SOURCE/scripts/setlocalversion"
          fi

          bash build.sh "$DEVICE" "$KSU_enable"

          mkdir -p "${WORKDIR}/out" || {
              echo "æ— æ³•åˆ›å»ºç›®å½•ï¼š${WORKDIR}/out" >&2
              exit 1
          }
          if ! compgen -G ./Kernel_*.zip > /dev/null; then
              echo "è­¦å‘Šï¼šæœªæ‰¾åˆ° Kernel_*.zip æ–‡ä»¶ï¼Œè·³è¿‡ç§»åŠ¨æ“ä½œ" >&2
              exit 0
          fi
          mv -v ./Kernel_*.zip "${WORKDIR}/out/" || {
              echo "ç§»åŠ¨æ–‡ä»¶æ—¶å‡ºé”™" >&2
              exit 1
          }

          echo "æ“ä½œæˆåŠŸå®Œæˆï¼"

      - name: ğŸ“¤ Upload AOSP compilation results (ä¸Šä¼ AOSPç¼–è¯‘ç»“æœ)
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-AOSP-${{ matrix.device }}
          path: ${{ github.workspace }}/out/Kernel_AOSP_*.zip

      - name: ğŸ“¤ Upload MIUI compilation results (ä¸Šä¼ MIUIç¼–è¯‘ç»“æœ)
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-MIUI-${{ matrix.device }}
          path: ${{ github.workspace }}/out/Kernel_MIUI_*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: ğŸ“¥ Download all zip artifacts (ä¸‹è½½æ‰€æœ‰ zip æ„å»ºäº§ç‰©)
      uses: actions/download-artifact@v4
      with:
        path: out

    - name: ğŸ“ Preparing files for release (å‡†å¤‡å‘å¸ƒæ–‡ä»¶)
      run: |
        if [[ ${{ github.event.inputs.build_type }} == Dev ]];then
           echo "æµ‹è¯•ç‰ˆå†…æ ¸ï¼Œä¸ä¸Šä¼ release"
           exit 1
        fi
        mkdir -p release
        cd ${{ github.workspace }}/out
        device_list=()
        for dir in */; do
          device_name=$(echo "$dir" | sed 's/Kernel-MIUI-//' | sed 's/Kernel-AOSP-//' | sed 's/\/$//')
          echo "Found device: $device_name"
          device_list+=("$device_name")
          cd "$dir"
        for zip_file in *; do
          if [[ -f "$zip_file" && "$zip_file" == *.zip ]]; then
          mv "$zip_file" ${{ github.workspace }}/release
        fi
          done
          cd ..
        done
        TARGET_DEVICES=$(echo "${device_list[*]}" | tr ' ' '-')
        echo "TARGET_DEVICES=$TARGET_DEVICES" >> $GITHUB_ENV

    - name: ğŸ“… Setting date variables (è®¾ç½®æ—¥æœŸå˜é‡)
      run: |
        echo "RELEASE_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        REPO_URL="https://github.com/liyafe1997/kernel_xiaomi_sm8250_mod.git"
        GIT_COMMIT_ID=$(git ls-remote $REPO_URL HEAD | cut -f1)
        echo "GIT_COMMIT_ID=$GIT_COMMIT_ID" >> $GITHUB_ENV
          
    - name: ğŸ“¤ Post to Release (å‘å¸ƒåˆ° Release)
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ github.workspace }}/release/*.zip
        name: Kernel_(${{ env.TARGET_DEVICES }})_${{ github.event.inputs.kernelsu_variant }}_${{ env.RELEASE_DATE }}_${{ env.GIT_COMMIT_ID }}_${{ github.event.inputs.build_type }}
        tag_name: Kernel_(${{ env.TARGET_DEVICES }})_${{ github.event.inputs.kernelsu_variant }}_${{ env.RELEASE_DATE }}_${{ env.GIT_COMMIT_ID }}
        body: |
          ## ğŸ“±kernel build information | å†…æ ¸æ„å»ºä¿¡æ¯
          
          ### ğŸ‡¨ğŸ‡³ ä¸­æ–‡ | Chinese
          - **ç›®æ ‡æœºå‹:** ${{ env.TARGET_DEVICES }}
          - **KernelSUæ”¯æŒ:** ${{ github.event.inputs.kernelsu_enable }}
          - **æ„å»ºç±»å‹:** ${{ github.event.inputs.build_type }}
          - **æ„å»ºæ—¥æœŸ:** ${{ env.RELEASE_DATE }}
          - **æäº¤ID:** ${{ env.GIT_COMMIT_ID }}
      
          ### ğŸ“‹ å®‰è£…è¯´æ˜ | Installation Guide
          1. ä¸‹è½½å¯¹åº”æœºå‹çš„åˆ·æœºåŒ…
          2. è¿›å…¥Recoveryæ¨¡å¼
          3. é€šè¿‡Recoveryåˆ·å…¥åˆ·æœºåŒ…
          4. é‡å¯è®¾å¤‡
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
